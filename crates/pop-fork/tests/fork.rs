// SPDX-License-Identifier: GPL-3.0

//! Pop-fork integration tests.

#![cfg(feature = "integration-tests")]

use paste::paste;
use pop_fork::rpc_server::test_scenarios::{
	archive as rpc_server_archive, author as rpc_server_author, block, blockchain, builder, chain,
	chain_head as rpc_server_chain_head, chain_spec, executor, local, remote, rpc,
	state as rpc_server_state, system as rpc_server_system, timestamp,
};
use std::{future::Future, time::Duration};

fn run_async<F>(future: F)
where
	F: Future<Output = ()>,
{
	let runtime = tokio::runtime::Builder::new_multi_thread()
		.enable_all()
		.build()
		.expect("tokio runtime should build");
	runtime.block_on(future);
	runtime.shutdown_timeout(Duration::from_secs(1));
}

macro_rules! scenario_tests {
	($($module:ident::$scenario:ident),+ $(,)?) => {
		paste! {
			$(
				#[test]
				fn [<$module _ $scenario>]() {
					run_async($module::$scenario());
				}
			)+
		}
	};
}

scenario_tests!(
	block::child_commits_parent_storage,
	block::child_creates_block_with_correct_metadata,
	block::child_storage_inherits_parent_modifications,
	block::fork_point_with_hash_creates_block_with_correct_metadata,
	block::fork_point_with_non_existent_hash_returns_error,
	block::fork_point_with_non_existent_number_returns_error,
	block::fork_point_with_number_creates_block_with_correct_metadata,
	blockchain::block_body_returns_extrinsics_for_fork_point_from_remote,
	blockchain::block_body_returns_extrinsics_for_head,
	blockchain::block_body_returns_extrinsics_for_parent_block,
	blockchain::block_body_returns_none_for_unknown_hash,
	blockchain::block_hash_at_returns_hash_for_block_before_fork_point,
	blockchain::block_hash_at_returns_hash_for_fork_point,
	blockchain::block_hash_at_returns_hash_for_head,
	blockchain::block_hash_at_returns_hash_for_parent_block,
	blockchain::block_hash_at_returns_none_for_future_block,
	blockchain::block_header_returns_header_for_different_blocks,
	blockchain::block_header_returns_header_for_fork_point,
	blockchain::block_header_returns_header_for_head,
	blockchain::block_header_returns_header_for_historical_block,
	blockchain::block_header_returns_none_for_unknown_hash,
	blockchain::block_number_by_hash_returns_none_for_unknown,
	blockchain::block_number_by_hash_returns_number_for_fork_point,
	blockchain::block_number_by_hash_returns_number_for_head,
	blockchain::block_number_by_hash_returns_number_for_historical_block,
	blockchain::block_number_by_hash_returns_number_for_parent,
	blockchain::build_block_result_tracks_failed_extrinsics,
	blockchain::build_block_result_tracks_included_extrinsics,
	blockchain::build_block_with_signed_transfer_updates_balances,
	blockchain::build_empty_block_advances_chain,
	blockchain::build_multiple_empty_blocks_creates_chain,
	blockchain::call_at_block_does_not_persist_storage,
	blockchain::call_at_block_executes_at_fork_point,
	blockchain::call_at_block_executes_at_head,
	blockchain::call_at_block_executes_at_historical_block,
	blockchain::call_at_block_executes_at_parent_block,
	blockchain::call_at_block_returns_none_for_unknown_hash,
	blockchain::call_executes_runtime_api,
	blockchain::fork_at_creates_blockchain_at_specific_block,
	blockchain::fork_at_with_invalid_block_number_fails,
	blockchain::fork_creates_blockchain_with_correct_fork_point,
	blockchain::fork_detects_relay_chain_type,
	blockchain::fork_retrieves_chain_name,
	blockchain::fork_with_invalid_endpoint_fails,
	blockchain::head_returns_current_block,
	blockchain::head_updates_after_building_block,
	blockchain::storage_at_queries_specific_block,
	blockchain::storage_returns_none_for_nonexistent_key,
	blockchain::storage_returns_value_for_existing_key,
	blockchain::validate_extrinsic_accepts_valid_transfer,
	blockchain::validate_extrinsic_rejects_garbage,
	builder::apply_extrinsic_before_inherents_fails,
	builder::apply_extrinsic_before_initialize_fails,
	builder::apply_inherents_before_initialize_fails,
	builder::apply_inherents_twice_fails,
	builder::apply_inherents_without_providers_returns_empty,
	builder::create_next_header_includes_digest_items,
	builder::create_next_header_increments_block_number,
	builder::finalize_before_inherents_fails,
	builder::finalize_before_initialize_fails,
	builder::finalize_produces_child_block,
	builder::initialize_succeeds_and_modifies_storage,
	builder::initialize_twice_fails,
	builder::new_creates_builder_with_empty_extrinsics,
	chain::scenario_chain_get_block_hash_returns_head_hash,
	chain::scenario_chain_get_block_hash_returns_none_hash,
	chain::scenario_chain_get_block_hash_without_number_returns_head_hash,
	chain::scenario_chain_get_block_returns_full_block,
	chain::scenario_chain_get_block_returns_head_when_no_hash,
	chain::scenario_chain_get_finalized_head_returns_head_hash,
	chain::scenario_chain_get_header_returns_head_when_no_hash,
	chain::scenario_chain_get_header_returns_number,
	chain::scenario_chain_get_header_returns_valid_header,
	chain_spec::scenario_chain_spec_chain_name_returns_string,
	chain_spec::scenario_chain_spec_genesis_hash_matches_archive,
	chain_spec::scenario_chain_spec_genesis_hash_returns_valid_hex_hash,
	chain_spec::scenario_chain_spec_properties_returns_json_or_null,
	executor::core_initialize_block_modifies_storage,
	executor::core_version_executes_successfully,
	executor::logs_are_captured_during_execution,
	executor::metadata_executes_successfully,
	executor::runtime_version_extracts_version_info,
	executor::storage_changes_persist_across_calls,
	executor::storage_reads_from_accumulated_changes,
	executor::with_config_applies_custom_settings,
	local::commit_empty_modifications,
	local::commit_multiple_times,
	local::commit_preserves_modifications,
	local::commit_validity_ranges_work_properly,
	local::commit_with_deletions,
	local::commit_writes_to_cache,
	local::delete_prefix_adds_to_deleted_prefixes,
	local::delete_prefix_blocks_parent_reads,
	local::delete_prefix_removes_matching_keys,
	local::delete_prefix_with_empty_prefix,
	local::diff_excludes_prefix_deleted_keys,
	local::diff_includes_deletions,
	local::diff_returns_all_modifications,
	local::diff_returns_empty_initially,
	local::get_batch_empty_keys,
	local::get_batch_falls_back_to_parent,
	local::get_batch_historical_block,
	local::get_batch_local_overrides_parent,
	local::get_batch_maintains_order,
	local::get_batch_mixed_block_scenarios,
	local::get_batch_mixed_sources,
	local::get_batch_non_existent_block_returns_none,
	local::get_batch_retrieves_modified_value_from_fork_history,
	local::get_batch_retrieves_unmodified_value_from_remote_at_past_forked_block,
	local::get_batch_returns_local_modifications,
	local::get_batch_returns_none_for_deleted_prefix,
	local::get_falls_back_to_parent,
	local::get_historical_block,
	local::get_local_overrides_parent,
	local::get_non_existent_block_returns_none,
	local::get_retrieves_modified_value_from_fork_history,
	local::get_retrieves_unmodified_value_from_remote_at_past_forked_block,
	local::get_returns_local_modification,
	local::get_returns_none_for_deleted_prefix_if_exact_key_not_found,
	local::get_returns_none_for_nonexistent_key,
	local::get_returns_some_for_deleted_prefix_if_exact_key_found_after_deletion,
	local::has_code_changed_at_returns_false_for_different_block,
	local::has_code_changed_at_returns_false_for_non_code_modifications,
	local::has_code_changed_at_returns_false_when_no_code_modified,
	local::has_code_changed_at_returns_true_when_code_modified,
	local::has_code_changed_at_tracks_modification_block_correctly,
	local::is_deleted_exact_match_only,
	local::is_deleted_returns_false_initially,
	local::is_deleted_returns_true_after_delete,
	local::metadata_at_fetches_from_remote_for_pre_fork_blocks,
	local::metadata_at_returns_metadata_for_future_blocks,
	local::new_creates_empty_layer,
	local::next_key_returns_next_key_from_parent,
	local::next_key_returns_none_when_all_remaining_deleted,
	local::next_key_returns_none_when_no_more_keys,
	local::next_key_skips_deleted_prefix,
	local::next_key_skips_multiple_deleted_keys,
	local::next_key_with_empty_prefix,
	local::next_key_with_nonexistent_prefix,
	local::register_metadata_version_adds_new_version,
	local::register_metadata_version_respects_block_boundaries,
	local::set_batch_duplicate_keys_last_wins,
	local::set_batch_empty_entries,
	local::set_batch_overwrites_previous_values,
	local::set_batch_stores_multiple_values,
	local::set_batch_with_deletions,
	local::set_overwrites_previous_value,
	local::set_stores_value,
	remote::accessor_methods,
	remote::fetch_and_cache_block_by_number_caches_block,
	remote::fetch_and_cache_block_by_number_idempotent,
	remote::fetch_and_cache_block_by_number_multiple_blocks,
	remote::fetch_and_cache_block_by_number_non_existent,
	remote::fetch_and_cache_block_by_number_verifies_parent_chain,
	remote::get_batch_fetches_mixed,
	remote::get_batch_uses_cache,
	remote::get_caches_empty_values,
	remote::get_fetches_and_caches,
	remote::layer_is_cloneable,
	remote::prefetch_prefix,
	rpc::connect_to_invalid_endpoint_fails,
	rpc::connect_to_node,
	rpc::fetch_finalized_head,
	rpc::fetch_header,
	rpc::fetch_header_non_existent_block_fails,
	rpc::fetch_metadata,
	rpc::fetch_runtime_code,
	rpc::fetch_storage,
	rpc::fetch_storage_batch,
	rpc::fetch_storage_batch_empty_keys,
	rpc::fetch_storage_batch_with_mixed_keys,
	rpc::fetch_storage_keys_paged,
	rpc::fetch_storage_non_existent_key_returns_none,
	rpc::fetch_system_chain,
	rpc::fetch_system_properties,
	rpc_server_archive::archive_body_is_idempotent_over_finalized_blocks,
	rpc_server_archive::archive_body_returns_extrinsics_for_valid_hashes,
	rpc_server_archive::archive_body_returns_none_for_unknown_hash,
	rpc_server_archive::archive_call_does_not_persist_storage_changes,
	rpc_server_archive::archive_call_executes_at_specific_block,
	rpc_server_archive::archive_call_executes_runtime_api,
	rpc_server_archive::archive_call_rejects_invalid_hex_hash,
	rpc_server_archive::archive_call_rejects_invalid_hex_parameters,
	rpc_server_archive::archive_call_returns_error_for_invalid_function,
	rpc_server_archive::archive_call_returns_null_for_unknown_block,
	rpc_server_archive::archive_finalized_height_returns_correct_value,
	rpc_server_archive::archive_genesis_hash_returns_valid_hash,
	rpc_server_archive::archive_hash_by_height_returns_hash_at_different_heights,
	rpc_server_archive::archive_hash_by_height_returns_none_for_unknown_height,
	rpc_server_archive::archive_header_is_idempotent_over_finalized_blocks,
	rpc_server_archive::archive_header_rejects_invalid_hex,
	rpc_server_archive::archive_header_returns_header_for_fork_point,
	rpc_server_archive::archive_header_returns_header_for_head_hash,
	rpc_server_archive::archive_header_returns_header_for_parent_block,
	rpc_server_archive::archive_header_returns_none_for_unknown_hash,
	rpc_server_archive::archive_storage_diff_detects_modified_value,
	rpc_server_archive::archive_storage_diff_handles_multiple_items,
	rpc_server_archive::archive_storage_diff_returns_added_for_new_key,
	rpc_server_archive::archive_storage_diff_returns_deleted_for_removed_key,
	rpc_server_archive::archive_storage_diff_returns_empty_for_unchanged_keys,
	rpc_server_archive::archive_storage_diff_returns_error_for_unknown_hash,
	rpc_server_archive::archive_storage_diff_returns_error_for_unknown_previous_hash,
	rpc_server_archive::archive_storage_diff_returns_hash_when_requested,
	rpc_server_archive::archive_storage_diff_uses_parent_when_previous_hash_omitted,
	rpc_server_archive::archive_storage_queries_at_specific_block,
	rpc_server_archive::archive_storage_returns_error_for_unknown_block,
	rpc_server_archive::archive_storage_returns_hash_when_requested,
	rpc_server_archive::archive_storage_returns_none_for_nonexistent_key,
	rpc_server_archive::archive_storage_returns_value_for_existing_key,
	rpc_server_author::author_pending_extrinsics_empty_after_submit,
	rpc_server_author::author_submit_and_watch_sends_invalid_on_validation_failure,
	rpc_server_author::author_submit_and_watch_sends_lifecycle_events,
	rpc_server_author::author_submit_extrinsic_does_not_build_block_on_validation_failure,
	rpc_server_author::author_submit_extrinsic_invalid_hex,
	rpc_server_author::author_submit_extrinsic_rejects_garbage_with_error_code,
	rpc_server_author::author_submit_extrinsic_returns_correct_hash,
	rpc_server_chain_head::follow_returns_subscription_and_initialized_event,
	rpc_server_chain_head::header_returns_header_for_valid_subscription,
	rpc_server_chain_head::invalid_subscription_returns_error,
	rpc_server_state::state_get_metadata_at_block_hash,
	rpc_server_state::state_get_metadata_returns_metadata,
	rpc_server_state::state_get_runtime_version_at_block_hash,
	rpc_server_state::state_get_runtime_version_returns_version,
	rpc_server_state::state_get_storage_at_block_hash,
	rpc_server_state::state_get_storage_invalid_block_hash_returns_error,
	rpc_server_state::state_get_storage_invalid_hex_returns_error,
	rpc_server_state::state_get_storage_returns_none_for_nonexistent_key,
	rpc_server_state::state_get_storage_returns_value,
	rpc_server_system::account_next_index_invalid_address_returns_error,
	rpc_server_system::account_next_index_returns_nonce,
	rpc_server_system::account_next_index_returns_zero_for_nonexistent,
	rpc_server_system::chain_works,
	rpc_server_system::health_works,
	rpc_server_system::name_works,
	rpc_server_system::properties_returns_json_or_null,
	rpc_server_system::version_works,
	timestamp::get_slot_duration_falls_back_when_aura_api_unavailable,
	timestamp::get_slot_duration_from_live_aura_chain,
	timestamp::get_slot_duration_from_live_babe_chain,
);
